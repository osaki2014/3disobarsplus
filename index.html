<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>3D天気図ビューアープラス</title>

<!-- three.js & addons via importmap -->
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/"
  }
}
</script>

<style>
  :root { --bg:#bfbfbf; --panel:#f8fafc; --muted:#6b7280; --border:#c8ced6; }
  html,body{height:100%;margin:0;background:var(--bg);color:#0f172a;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif}
  #app{display:grid;grid-template-columns:1fr 420px;grid-template-rows:56px 1fr;height:100%}
  #app[data-panel="closed"]{grid-template-columns:1fr 0}
  header{grid-column:1/-1;display:flex;align-items:center;gap:.6rem;padding:.5rem .9rem;border-bottom:1px solid var(--border);background:#f3f5f7}
  header h1{font-size:15px;margin:0}
  header .sp{flex:1}
  header a{font-size:13px;color:#0b57d0;text-decoration:none}
  header a:hover{text-decoration:underline}
  header button,header label,header select{background:#fff;border:1px solid var(--border);color:#0f172a;padding:.45rem .7rem;border-radius:.5rem;cursor:pointer;font-size:13px}
  header input[type=file]{display:none}
  #viewer{position:relative;background:#fff}
  #c{width:100%;height:100%}
  #overlay{position:absolute;left:12px;bottom:12px;padding:.45rem .6rem;background:#ffffffcc;border:1px solid var(--border);border-radius:.6rem;font-size:12px;color:#334155}
  #dragHud{position:absolute;pointer-events:none;transform:translate(-50%,-130%);padding:.25rem .45rem;font-size:12px;border-radius:.4rem;background:#0009;color:#fff;border:1px solid #0003;display:none;white-space:nowrap}
  #sidebar{background:var(--panel);border-left:1px solid var(--border);overflow:auto;padding:.8rem}
  #app[data-panel="closed"] #sidebar{display:none}
  .section{margin-bottom:1rem}
  .section h2{font-size:13px;margin:.3rem 0}
  .row{display:grid;grid-template-columns:1fr auto;gap:.6rem;align-items:center;margin:.45rem 0}
  .row label{font-size:12px;color:var(--muted)}
  #list{display:grid;gap:.6rem}
  .card{border:1px solid var(--border);background:#fff;border-radius:.6rem;padding:.6rem}
  .card .t{display:flex;gap:.5rem;align-items:center;margin-bottom:.3rem}
  .chip{display:inline-flex;align-items:center;gap:.4rem;border:1px solid var(--border);background:#f3f5f7;padding:.2rem .5rem;border-radius:999px;font-size:12px}
  .small{font-size:12px}
  .muted{color:#6b7280;font-size:12px;margin-left:.4rem}
  canvas.grabbing{cursor:grabbing}
  canvas.hovering{cursor:ns-resize}
</style>
</head>
<body>
<div id="app" data-panel="open">
  <header>
    <h1>3D天気図ビューアープラス</h1>

    <a href="https://www.data.jma.go.jp/yoho/wxchart/quickmonthly.html" target="_blank" rel="noopener noreferrer">
      気象庁による過去の実況天気図
    </a>

    <span class="sp"></span>

    <!-- 投影法 -->
    <select id="projection">
      <option value="persp" selected>透視図法</option>
      <option value="ortho">正射影図法</option>
    </select>

    <!-- ビュー -->
    <select id="viewSelect">
      <option value="all">斜め視点</option>
      <option value="top">真上（XY）</option>
      <option value="front">正面（ZX）</option>
      <option value="side">側面（ZY）</option>
    </select>

    <!-- ファイル -->
    <label for="file">SVG/SVGZを開く</label><input id="file" type="file" accept=".svg,.svgz,image/svg+xml,application/gzip">

    <!-- STL -->
    <button id="exportStl">STLを書き出し</button>

    <!-- パネル -->
    <button id="panelToggle">パネル</button>
  </header>

  <div id="viewer">
    <canvas id="c"></canvas>
    <div id="overlay">ドラッグ:回転 / 右ドラッグ:平行移動 / ホイール:ズーム / 線上ドラッグ:高さ変更（Shift=微 / Alt=粗）</div>
    <div id="dragHud"></div>
  </div>

  <aside id="sidebar">
    <div class="section">
      <h2>全体設定</h2>
      <div class="row"><label>背景色</label><input id="bgColor" type="color" value="#bfbfbf"></div>
      <div class="row"><label>基準（軸＆キューブ）表示</label><input id="basisVisible" type="checkbox" checked></div>
      <div class="row"><label>グリッド表示（XY/ZX）</label><input id="gridVisible" type="checkbox" checked></div>
      <div class="row"><label>高さ倍率（Z）</label><input id="heightScale" type="range" min="0.1" max="20" step="0.1" value="5"></div>
      <div class="row"><label>ドラッグ感度（px→高さ）</label><input id="dragSensitivity" type="range" min="0.05" max="2.0" step="0.05" value="0.3"></div>
      <div class="row"><label>サンプリング密度（新規読込時）</label><input id="sample" type="range" min="32" max="1000" step="1" value="240"></div>
    </div>

    <div class="section">
      <h2>天気図画像（下敷き）</h2>
      <div class="row"><label>表示</label><input id="imgVisible" type="checkbox" checked></div>
      <div class="row"><label>不透明度</label><input id="imgOpacity" type="range" min="0" max="1" step="0.01" value="0.85"></div>
      <div class="row"><label>高さ（Zオフセット）</label><input id="imgHeight" type="range" min="-200" max="200" step="0.1" value="-0.1"></div>
    </div>

    <div class="section">
      <h2>自動高さ（ラベル順・色も連動）</h2>
      <!-- ★ 初期はオフにするため checked を削除 -->
      <div class="row"><label>有効</label><input id="autoMode" type="checkbox"></div>
      <div class="row"><label>間隔倍率</label><input id="gapFactor" type="range" min="0.2" max="3" step="0.05" value="1"></div>
      <div class="row"><label>平坦 ←→ 初期間隔</label><input id="autoBlend" type="range" min="0" max="1" step="0.01" value="1"></div>
      <div class="row"><span class="muted" id="labelInfo">ラベル未解析</span><span></span></div>
    </div>

    <div class="section">
      <h2>表示モード</h2>
      <div class="row"><label>パイプ（Tube）</label><input id="modePipe" type="checkbox" checked></div>
      <div class="row"><label>壁（Wall：帯押し出し）</label><input id="modeWall" type="checkbox"></div>
      <div class="row"><label>パイプ直径</label><input id="pipeDia" type="range" min="0.2" max="12" step="0.1" value="6.0"></div>
      <div class="row"><label>壁の厚さ（帯幅）</label><input id="wallThick" type="range" min="0.2" max="16" step="0.1" value="2.5"></div>
      <div class="row"><label>壁の不透明度</label><input id="wallOpacity" type="range" min="0" max="1" step="0.01" value="0.9"></div>
      <div class="row"><span class="muted">※パイプ/壁は同時表示可。ドラッグは表示中の形状に有効。</span><span></span></div>
    </div>

    <div class="section">
      <h2>等圧線リスト</h2>
      <div id="list"></div>
    </div>
  </aside>
</div>

<!-- ここから下は JavaScript（省略、前と同じ内容） -->
<script type="module">
/* … 省略: JavaScript 本体は前回提示のコードと同じ … */
</script>
</body>
</html>
